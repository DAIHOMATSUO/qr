<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğŸ“± ã‚¹ãƒãƒ›QRåœ¨åº«ã‚¹ã‚­ãƒ£ãƒ³</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 16px;
      color: white;
      min-height: 100vh;
      font-size: 16px;
      touch-action: manipulation;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin: 0 0 24px 0;
      font-size: 24px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .camera-section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    #reader {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      min-height: 250px;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(45deg, #f44336, #d32f2f);
      color: white;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .status {
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      font-weight: 500;
    }
    
    .status-success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.5);
    }
    
    .status-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.5);
    }
    
    .status-info {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.5);
    }
    
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      z-index: 1000;
      padding: 20px;
    }
    
    .confirm-content {
      background: white;
      color: #333;
      padding: 24px;
      border-radius: 16px;
      margin-top: 20%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .confirm-text {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .confirm-buttons {
      display: flex;
      gap: 12px;
    }
    
    .confirm-buttons .btn {
      flex: 1;
      margin: 0;
    }
    
    .summary-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .data-table {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .table-header {
      background: rgba(255,255,255,0.2);
      padding: 12px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .table-row {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }
    
    .table-row:last-child {
      border-bottom: none;
    }
    
    .hidden {
      display: none !important;
    }
    
    .mt-auto {
      margin-top: auto;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
    }
    
    @media (max-height: 600px) {
      body {
        padding: 8px;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 16px;
      }
      .camera-section {
        padding: 16px;
      }
      #reader {
        min-height: 200px;
      }
    }

    // å¤§é‡ã‚¹ã‚­ãƒ£ãƒ³å¯¾å¿œãƒ¢ãƒ¼ãƒ‰
    function enableBulkMode() {
      const options = [
        'ğŸš€ é«˜é€Ÿã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ\n',
        'âœ… è‡ªå‹•ç¢ºèªï¼šã‚¹ã‚­ãƒ£ãƒ³å¾Œã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—',
        'âš¡ é«˜é€Ÿå‡¦ç†ï¼šã‚¹ã‚­ãƒ£ãƒ³é–“éš”ã‚’çŸ­ç¸®',
        'ğŸ’¾ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š100ä»¶ã”ã¨ã«è‡ªå‹•ä¿å­˜',
        'ğŸ”‹ çœé›»åŠ›ï¼šç”»é¢ã®è‡ªå‹•ã‚ªãƒ•ã‚’é˜²æ­¢\n',
        'âš ï¸ æ³¨æ„ï¼šèª¤èª­ã¿å–ã‚Šã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™'
      ].join('\n');
      
      if (confirm(options)) {
        isBulkMode = true;
        bulkModeSettings.autoConfirm = true;
        bulkModeSettings.fastScan = true;
        bulkModeSettings.autoBackup = true;
        
        // ç”»é¢ã®è‡ªå‹•ã‚ªãƒ•é˜²æ­¢
        if ('wakeLock' in navigator) {
          navigator.wakeLock.request('screen').catch(console.error);
        }
        
        updateStatus('ğŸš€ é«˜é€Ÿã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ï¼ç¢ºèªãªã—ã§é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™', 'success');
        
        // ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯è‡ªå‹•èµ·å‹•
        if (!isScanning) {
          setTimeout(startCamera, 1000);
        }
      }
    }

    // ãƒãƒ«ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®é«˜é€Ÿç¢ºèª
    function quickConfirmScan() {
      if (!pendingData) return;
      
      // ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ï¼ˆç¢ºèªãªã—ï¼‰
      scanData.push({...pendingData});
      totalCount++;
      totalQuantity += pendingData.quantity;
      
      updateSummary();
      updateDataDisplay();
      saveData();
      
      // 100ä»¶ã”ã¨ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      if (bulkModeSettings.autoBackup && totalCount % 100 === 0) {
        exportData();
        updateStatus(`ğŸ’¾ ${totalCount}ä»¶åˆ°é”ï¼è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ`, 'success');
      } else {
        updateStatus(`âš¡ ${totalCount}ä»¶ç™»éŒ²å®Œäº† (æ®‹ã‚Šç´„${2000-totalCount}ä»¶)`, 'success');
      }
      
      pendingData = null;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± QRåœ¨åº«ã‚¹ã‚­ãƒ£ãƒ³</h1>
    
    <!-- ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="camera-section">
      <div id="reader"></div>
      <button id="startBtn" class="btn btn-primary">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="stopBtn" class="btn btn-danger hidden">â¹ï¸ ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <div id="status" class="status status-info">ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    </div>
    
    <!-- é›†è¨ˆè¡¨ç¤º -->
    <div class="summary-card">
      <div class="summary-item">
        <span>ğŸ“‹ èª­ã¿å–ã‚Šä»¶æ•°</span>
        <span id="count">0ä»¶</span>
      </div>
      <div class="summary-item">
        <span>ğŸ“¦ åˆè¨ˆæ•°é‡</span>
        <span id="total">0å€‹</span>
      </div>
    </div>
    
    <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="quick-actions">
      <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
      <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
    </div>
    
    <!-- ç·Šæ€¥æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
    <div style="text-align: center; margin: 16px 0;">
      <button class="btn btn-secondary" onclick="manualInput()" style="background: rgba(255,193,7,0.3); border-color: rgba(255,193,7,0.5);">
        âŒ¨ï¸ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
      </button>
    </div>
    
    <!-- ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
    <button class="btn btn-secondary" onclick="testScan()">ğŸ§ª ãƒ†ã‚¹ãƒˆèª­ã¿å–ã‚Š</button>
    <button class="btn btn-secondary" onclick="checkCameraPermission()">ğŸ” ã‚«ãƒ¡ãƒ©è¨­å®šç¢ºèª</button>
    <button class="btn btn-secondary" onclick="resetAllPermissions()">ğŸ”„ å®Œå…¨ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ</button>
    
    <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
    <div id="dataSection" class="hidden">
      <div class="data-table">
        <div class="table-header">ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</div>
        <div id="dataList"></div>
      </div>
    </div>
  </div>
  
  <!-- æ‰‹å‹•å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="manualDialog" class="confirm-dialog">
    <div class="confirm-content">
      <h3 style="margin-top: 0;">âŒ¨ï¸ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</h3>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px;">ğŸ“… æ—¥ä»˜ (YYYY/MM/DD)</label>
        <input type="text" id="manualDate" placeholder="2025/07/22" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
      </div>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px;">ğŸ·ï¸ å®¢å…ˆå“ç•ª</label>
        <input type="text" id="manualProduct" placeholder="85244-63R20-5PKCO" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
      </div>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px;">ğŸ”¢ æ•°é‡</label>
        <input type="number" id="manualQuantity" placeholder="18" min="1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
      </div>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px;">ğŸ“‹ ç¤¾å†…ç®¡ç†å“ç•ª</label>
        <input type="text" id="manualInternal" placeholder="SNCA00000090" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
      </div>
      <div class="confirm-buttons">
        <button class="btn btn-danger" onclick="closeManualInput()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitManualInput()">âœ… ç™»éŒ²</button>
      </div>
    </div>
  </div>
    <div class="confirm-content">
      <div id="confirmText" class="confirm-text"></div>
      <div class="confirm-buttons">
        <button class="btn btn-danger" onclick="cancelScan()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="confirmScan()">âœ… ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let scanner = null;
    let isScanning = false;
    let pendingData = null;
    let scanData = [];
    let totalCount = 0;
    let totalQuantity = 0;
    let isBulkMode = false;
    let bulkModeSettings = {
      autoConfirm: false,
      fastScan: false,
      autoBackup: false
    };

    // DOMè¦ç´ 
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmText = document.getElementById('confirmText');
    const countEl = document.getElementById('count');
    const totalEl = document.getElementById('total');
    const dataSection = document.getElementById('dataSection');
    const dataList = document.getElementById('dataList');

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      startBtn.addEventListener('click', startCamera);
      stopBtn.addEventListener('click', stopCamera);
      loadSavedData();
      
      // PWAå¯¾å¿œ
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript,');
      }
    });

    // ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆå¼·åŒ–ç‰ˆã‚¨ãƒ©ãƒ¼è¨ºæ–­ä»˜ãï¼‰
    async function startCamera() {
      if (isScanning) return;
      
      try {
        updateStatus('ğŸ” ã‚«ãƒ¡ãƒ©èµ·å‹•å‰è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...', 'info');
        
        // æ®µéš1: åŸºæœ¬çš„ãªç’°å¢ƒãƒã‚§ãƒƒã‚¯
        const diagnostics = [];
        
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        if (!navigator.mediaDevices) {
          diagnostics.push('âŒ MediaDevices APIæœªå¯¾å¿œ');
          updateStatus('âŒ ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
          showDetailedError('ãƒ–ãƒ©ã‚¦ã‚¶éå¯¾å¿œ', diagnostics);
          return;
        }
        diagnostics.push('âœ… MediaDevices APIå¯¾å¿œ');
        
        if (!navigator.mediaDevices.getUserMedia) {
          diagnostics.push('âŒ getUserMediaæœªå¯¾å¿œ');
          updateStatus('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
          showDetailedError('getUserMediaéå¯¾å¿œ', diagnostics);
          return;
        }
        diagnostics.push('âœ… getUserMediaå¯¾å¿œ');
        
        // Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
        if (typeof Html5Qrcode === 'undefined') {
          diagnostics.push('âŒ QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­ã¿è¾¼ã¿');
          updateStatus('âŒ QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
          showDetailedError('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒ©ãƒ¼', diagnostics);
          return;
        }
        diagnostics.push('âœ… QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿æ¸ˆã¿');
        
        updateStatus('ğŸ“· ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œä¸­...', 'info');
        
        // æ®µéš2: ç›´æ¥çš„ãªã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        let testStream = null;
        try {
          testStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: { ideal: "environment" },
              width: { ideal: 640 },
              height: { ideal: 480 }
            } 
          });
          diagnostics.push('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
          
          // ãƒ†ã‚¹ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
          testStream.getTracks().forEach(track => track.stop());
          
        } catch (accessError) {
          diagnostics.push(`âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${accessError.name}`);
          updateStatus(`âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${accessError.name}`, 'error');
          showDetailedError('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—', diagnostics, accessError);
          return;
        }
        
        updateStatus('ğŸ“· QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åˆæœŸåŒ–ä¸­...', 'info');
        
        // æ®µéš3: Html5Qrcodeã§ã‚«ãƒ¡ãƒ©èµ·å‹•
        try {
          scanner = new Html5Qrcode("reader");
          
          // ã‚«ãƒ¡ãƒ©ä¸€è¦§å–å¾—
          const cameras = await Html5Qrcode.getCameras();
          diagnostics.push(`âœ… æ¤œå‡ºã‚«ãƒ¡ãƒ©æ•°: ${cameras.length}`);
          
          if (!cameras || cameras.length === 0) {
            diagnostics.push('âŒ åˆ©ç”¨å¯èƒ½ã‚«ãƒ¡ãƒ©ãªã—');
            updateStatus('âŒ åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
            showDetailedError('ã‚«ãƒ¡ãƒ©æœªæ¤œå‡º', diagnostics);
            return;
          }
          
          // èƒŒé¢ã‚«ãƒ¡ãƒ©é¸æŠ
          let selectedCamera = cameras[0];
          for (let camera of cameras) {
            const label = camera.label.toLowerCase();
            if (label.includes('back') || label.includes('rear') || label.includes('environment')) {
              selectedCamera = camera;
              break;
            }
          }
          diagnostics.push(`âœ… é¸æŠã‚«ãƒ¡ãƒ©: ${selectedCamera.label || 'Unknown'}`);
          
          // ã‚«ãƒ¡ãƒ©èµ·å‹•
          await scanner.start(
            selectedCamera.id,
            {
              fps: 10,
              qrbox: function(viewfinderWidth, viewfinderHeight) {
                const minSize = Math.min(viewfinderWidth, viewfinderHeight);
                const size = Math.floor(minSize * 0.7);
                return { width: size, height: size };
              },
              aspectRatio: 1.0
            },
            onScanSuccess,
            onScanFailure
          );
          
          diagnostics.push('âœ… Html5Qrcodeèµ·å‹•æˆåŠŸ');
          
          // æˆåŠŸæ™‚ã®å‡¦ç†
          isScanning = true;
          startBtn.classList.add('hidden');
          stopBtn.classList.remove('hidden');
          updateStatus('âœ… ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„', 'success');
          
          console.log('ã‚«ãƒ¡ãƒ©èµ·å‹•è¨ºæ–­çµæœ:', diagnostics);
          
        } catch (qrError) {
          diagnostics.push(`âŒ Html5Qrcodeèµ·å‹•å¤±æ•—: ${qrError.message}`);
          updateStatus(`âŒ QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼`, 'error');
          showDetailedError('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•å¤±æ•—', diagnostics, qrError);
          return;
        }
        
      } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus(`âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showDetailedError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼', [], error);
      }
    }

    // è©³ç´°ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showDetailedError(errorType, diagnostics, error = null) {
      let message = `ğŸ” ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼è¨ºæ–­çµæœ\n\n`;
      message += `âŒ ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${errorType}\n\n`;
      
      if (diagnostics.length > 0) {
        message += `ğŸ“‹ è¨ºæ–­çµæœ:\n`;
        diagnostics.forEach(diag => message += `${diag}\n`);
        message += `\n`;
      }
      
      if (error) {
        message += `ğŸ› è©³ç´°ã‚¨ãƒ©ãƒ¼: ${error.name}\n`;
        message += `ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}\n\n`;
      }
      
      // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®è§£æ±ºç­–
      message += `ğŸ’¡ è§£æ±ºç­–:\n\n`;
      
      if (errorType === 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—') {
        if (error && error.name === 'NotAllowedError') {
          message += `ğŸ”’ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™\n`;
          message += `â€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„\n`;
          message += `â€¢ ã€ŒğŸ” ã‚«ãƒ¡ãƒ©è¨­å®šç¢ºèªã€ã§è©³ç´°æ‰‹é †ã‚’ç¢ºèª\n`;
        } else if (error && error.name === 'NotFoundError') {
          message += `ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n`;
          message += `â€¢ ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ\n`;
          message += `â€¢ ç«¯æœ«ã‚’å†èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„\n`;
        } else if (error && error.name === 'NotSupportedError') {
          message += `ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼\n`;
          message += `â€¢ HTTPSã¾ãŸã¯file://ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„\n`;
        } else {
          message += `â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\n`;
          message += `â€¢ åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã—ã¦ãã ã•ã„\n`;
        }
      } else if (errorType === 'ãƒ–ãƒ©ã‚¦ã‚¶éå¯¾å¿œ') {
        message += `â€¢ Chrome, Safari, Firefox ã®æœ€æ–°ç‰ˆã‚’ä½¿ç”¨\n`;
        message += `â€¢ å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ä½œã—ã¾ã›ã‚“\n`;
      } else if (errorType === 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒ©ãƒ¼') {
        message += `â€¢ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n`;
        message += `â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\n`;
      } else {
        message += `â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n`;
        message += `â€¢ ç«¯æœ«ã®å†èµ·å‹•\n`;
        message += `â€¢ åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦è¡Œ\n`;
      }
      
      message += `\nğŸ“ ã•ã‚‰ã«ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ã€ã“ã®è¨ºæ–­çµæœã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚`;
      
      console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±:', message);
      alert(message);
      
      // è¨ºæ–­çµæœã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      console.log('è¨ºæ–­æƒ…å ±:', {
        errorType,
        diagnostics,
        error,
        userAgent: navigator.userAgent,
        url: location.href,
        protocol: location.protocol
      });
    }

    // æ¨©é™ãƒªã‚»ãƒƒãƒˆæ‰‹é †è¡¨ç¤º
    function showPermissionReset() {
      const userAgent = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(userAgent);
      const isAndroid = /Android/.test(userAgent);
      const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
      const isChrome = /Chrome/.test(userAgent);
      
      let message = 'ğŸ”“ NotAllowedError è§£æ±ºæ‰‹é †\n\n';
      message += 'âŒ ç¾åœ¨ã®çŠ¶æ³: ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒã€Œæ‹’å¦ã€ã•ã‚Œã¦ã„ã¾ã™\n\n';
      
      if (isIOS && isSafari) {
        message += 'ğŸ iPhone Safari ã§ã®è§£æ±ºæ³•:\n\n';
        message += 'ğŸ“ æ–¹æ³•1: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‹ã‚‰è¨­å®š\n';
        message += '1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ã€ŒAAã€ã‚’ã‚¿ãƒƒãƒ—\n';
        message += '2. ã€ŒWebã‚µã‚¤ãƒˆã®è¨­å®šã€ã‚’ã‚¿ãƒƒãƒ—\n';
        message += '3. ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n';
        message += '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n\n';
        message += 'ğŸ“ æ–¹æ³•2: å®Œå…¨ãƒªã‚»ãƒƒãƒˆ\n';
        message += '1. è¨­å®šâ†’Safariâ†’ã€Œå±¥æ­´ã¨Webã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã€\n';
        message += '2. Safariã‚¢ãƒ—ãƒªã‚’å®Œå…¨çµ‚äº†\n';
        message += '3. ã‚µã‚¤ãƒˆã«å†ã‚¢ã‚¯ã‚»ã‚¹\n\n';
      } else if (isAndroid && isChrome) {
        message += 'ğŸ¤– Android Chrome ã§ã®è§£æ±ºæ³•:\n\n';
        message += 'ğŸ“ æ–¹æ³•1: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‹ã‚‰è¨­å®š\n';
        message += '1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ã‚’ã‚¿ãƒƒãƒ—\n';
        message += '2. ã€Œæ¨©é™ã€ã‚’ã‚¿ãƒƒãƒ—\n';
        message += '3. ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n';
        message += '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n\n';
        message += 'ğŸ“ æ–¹æ³•2: å®Œå…¨ãƒªã‚»ãƒƒãƒˆ\n';
        message += '1. Chromeè¨­å®šâ†’ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼â†’é–²è¦§å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤\n';
        message += '2. ã€ŒCookieã¨ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã€ã‚’ãƒã‚§ãƒƒã‚¯\n';
        message += '3. ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã€â†’Chromeã‚’å†èµ·å‹•\n\n';
      } else {
        message += 'ğŸŒ ãã®ä»–ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®è§£æ±ºæ³•:\n\n';
        message += '1. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚µã‚¤ãƒˆã®æ¨©é™ã‚’ç¢ºèª\n';
        message += '2. ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n';
        message += '3. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n\n';
      }
      
      message += 'âš¡ ç·Šæ€¥å›é¿ç­–:\n';
      message += 'â€¢ æ–°ã—ã„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¿ãƒ–ã§é–‹ã\n';
      message += 'â€¢ åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨\n';
      message += 'â€¢ ã€ŒâŒ¨ï¸ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã€ã§ä¸€æ™‚çš„ã«ä½œæ¥­ç¶™ç¶š\n\n';
      
      message += 'ğŸ”„ è¨­å®šå¤‰æ›´å¾Œã¯å¿…ãšãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ï¼';
      
      alert(message);
      updateStatus('ğŸ”“ æ¨©é™ãƒªã‚»ãƒƒãƒˆæ‰‹é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'info');
    }

    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
    function resetAllPermissions() {
      const userAgent = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(userAgent);
      const isAndroid = /Android/.test(userAgent);
      const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
      
      let resetSteps = 'ğŸ”„ å®Œå…¨ãƒªã‚»ãƒƒãƒˆæ‰‹é †\n\n';
      resetSteps += 'âš ï¸ ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ä¿å­˜ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\n';
      
      if (isIOS && isSafari) {
        resetSteps += 'ğŸ iPhone Safari:\n';
        resetSteps += '1. è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari\n';
        resetSteps += '2. ã€Œå±¥æ­´ã¨Webã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã€ã‚’ã‚¿ãƒƒãƒ—\n';
        resetSteps += '3. ã€Œå±¥æ­´ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã€ã§ç¢ºèª\n';
        resetSteps += '4. Safariã‚¢ãƒ—ãƒªã‚’å®Œå…¨çµ‚äº†ï¼ˆã‚¢ãƒ—ãƒªã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼ã‹ã‚‰ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰\n';
        resetSteps += '5. iPhoneå†èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰\n';
        resetSteps += '6. Safariã§ã‚µã‚¤ãƒˆã«å†ã‚¢ã‚¯ã‚»ã‚¹\n\n';
        
      } else if (isAndroid) {
        resetSteps += 'ğŸ¤– Android Chrome:\n';
        resetSteps += '1. Chrome â†’ è¨­å®šï¼ˆå³ä¸Šâ‹®ï¼‰\n';
        resetSteps += '2. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ é–²è¦§å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤\n';
        resetSteps += '3. æ™‚é–“ç¯„å›²ã€Œå…¨æœŸé–“ã€ã‚’é¸æŠ\n';
        resetSteps += '4. âœ“ Cookieã¨ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿\n';
        resetSteps += '5. âœ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸç”»åƒã¨ãƒ•ã‚¡ã‚¤ãƒ«\n';
        resetSteps += '6. âœ“ ã‚µã‚¤ãƒˆã®è¨­å®š\n';
        resetSteps += '7. ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã€\n';
        resetSteps += '8. Chromeå®Œå…¨çµ‚äº† â†’ ç«¯æœ«å†èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰\n';
        resetSteps += '9. Chromeã§ã‚µã‚¤ãƒˆã«å†ã‚¢ã‚¯ã‚»ã‚¹\n\n';
      }
      
      resetSteps += 'ğŸ†˜ ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªå ´åˆ:\n';
      resetSteps += 'â€¢ åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆChrome â†” Firefoxï¼‰\n';
      resetSteps += 'â€¢ ç«¯æœ«ã®è¨­å®š â†’ ã‚¢ãƒ—ãƒª â†’ ãƒ–ãƒ©ã‚¦ã‚¶ â†’ æ¨©é™ â†’ ã‚«ãƒ¡ãƒ©ã‚’ç¢ºèª\n';
      resetSteps += 'â€¢ æœ€çµ‚æ‰‹æ®µï¼šã€ŒâŒ¨ï¸ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã€ã§æ¥­å‹™ç¶™ç¶š\n\n';
      
      resetSteps += 'âœ… æ‰‹å‹•å…¥åŠ›ãªã‚‰ç¢ºå®Ÿã«å‹•ä½œã—ã¾ã™ï¼';
      
      if (confirm('å®Œå…¨ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\n' + resetSteps)) {
        updateStatus('ğŸ”„ ä¸Šè¨˜æ‰‹é †ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
      }
    }

    // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    function manualInput() {
      document.getElementById('manualDialog').style.display = 'block';
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
      const today = new Date();
      const dateStr = today.getFullYear() + '/' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '/' + 
                     String(today.getDate()).padStart(2, '0');
      document.getElementById('manualDate').value = dateStr;
      
      // æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        document.getElementById('manualProduct').focus();
      }, 100);
    }

    // æ‰‹å‹•å…¥åŠ›ã‚’é–‰ã˜ã‚‹
    function closeManualInput() {
      document.getElementById('manualDialog').style.display = 'none';
      
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('manualDate').value = '';
      document.getElementById('manualProduct').value = '';
      document.getElementById('manualQuantity').value = '';
      document.getElementById('manualInternal').value = '';
    }

    // æ‰‹å‹•å…¥åŠ›ã‚’é€ä¿¡
    function submitManualInput() {
      const date = document.getElementById('manualDate').value.trim();
      const product = document.getElementById('manualProduct').value.trim();
      const quantity = parseInt(document.getElementById('manualQuantity').value);
      const internal = document.getElementById('manualInternal').value.trim();
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!date) {
        alert('âŒ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!product) {
        alert('âŒ å®¢å…ˆå“ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!quantity || quantity <= 0) {
        alert('âŒ æ­£ã—ã„æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!internal) {
        alert('âŒ ç¤¾å†…ç®¡ç†å“ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      if (!/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(date)) {
        alert('âŒ æ—¥ä»˜ã¯YYYY/MM/DDå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒ‡ãƒ¼ã‚¿ä½œæˆ
      pendingData = {
        date: date,
        productCode: product,
        quantity: quantity,
        internalCode: internal,
        timestamp: new Date().toLocaleTimeString()
      };
      
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      closeManualInput();
      showConfirmDialog();
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢
    async function stopCamera() {
      if (!isScanning || !scanner) return;
      
      try {
        await scanner.stop();
        scanner = null;
        isScanning = false;
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        updateStatus('â¹ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
      } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        scanner = null;
        isScanning = false;
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        updateStatus('â¹ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
      }
    }

    // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚ŠæˆåŠŸ
    function onScanSuccess(decodedText) {
      try {
        // CSVå½¢å¼è§£æ
        const parts = parseCSV(decodedText);
        if (parts.length !== 4) {
          updateStatus('âŒ QRã‚³ãƒ¼ãƒ‰å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼ˆ4é …ç›®å¿…è¦ï¼‰', 'error');
          return;
        }

        const [date, productCode, quantityStr, internalCode] = parts;
        const quantity = parseInt(quantityStr);

        if (isNaN(quantity) || quantity <= 0) {
          updateStatus('âŒ æ•°é‡ãŒä¸æ­£ã§ã™', 'error');
          return;
        }

        pendingData = {
          date: date.trim(),
          productCode: productCode.trim(),
          quantity: quantity,
          internalCode: internalCode.trim(),
          timestamp: new Date().toLocaleTimeString()
        };

        // ãƒãƒ«ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è‡ªå‹•ç¢ºèª
        if (isBulkMode && bulkModeSettings.autoConfirm) {
          quickConfirmScan();
        } else {
          showConfirmDialog();
        }
        
      } catch (error) {
        console.error('QRè§£æã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ QRã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ©ãƒ¼', 'error');
      }
    }

    // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå¤±æ•—ï¼ˆæ­£å¸¸ï¼‰
    function onScanFailure(error) {
      // ä½•ã‚‚ã—ãªã„ï¼ˆã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­ï¼‰
    }

    // CSVè§£æ
    function parseCSV(text) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        if (char === '"') {
          if (inQuotes && text[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    function showConfirmDialog() {
      if (!pendingData) return;
      
      confirmText.innerHTML = `
        <strong>ğŸ“¦ ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</strong><br><br>
        ğŸ“… æ—¥ä»˜: ${pendingData.date}<br>
        ğŸ·ï¸ å“ç•ª: ${pendingData.productCode}<br>
        ğŸ”¢ æ•°é‡: ${pendingData.quantity}<br>
        ğŸ“‹ ç®¡ç†ç•ªå·: ${pendingData.internalCode}
      `;
      
      confirmDialog.style.display = 'block';
    }

    // ã‚¹ã‚­ãƒ£ãƒ³ç¢ºå®š
    function confirmScan() {
      if (!pendingData) return;
      
      scanData.push({...pendingData});
      totalCount++;
      totalQuantity += pendingData.quantity;
      
      updateSummary();
      updateDataDisplay();
      saveData();
      
      confirmDialog.style.display = 'none';
      pendingData = null;
      
      updateStatus(`âœ… ç™»éŒ²å®Œäº†ï¼ (${totalCount}ä»¶ç›®)`, 'success');
    }

    // ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelScan() {
      confirmDialog.style.display = 'none';
      pendingData = null;
      updateStatus('ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­...', 'info');
    }

    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary() {
      countEl.textContent = `${totalCount}ä»¶`;
      totalEl.textContent = `${totalQuantity}å€‹`;
    }

    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°
    function updateDataDisplay() {
      if (scanData.length === 0) {
        dataSection.classList.add('hidden');
        return;
      }
      
      dataSection.classList.remove('hidden');
      dataList.innerHTML = '';
      
      scanData.slice(-10).reverse().forEach((item, index) => {
        const row = document.createElement('div');
        row.className = 'table-row';
        row.innerHTML = `
          <strong>${item.productCode}</strong> Ã— ${item.quantity}<br>
          <small>${item.date} | ${item.timestamp}</small>
        `;
        dataList.appendChild(row);
      });
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(message, type) {
      status.textContent = message;
      status.className = `status status-${type}`;
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
      try {
        localStorage.setItem('qr_scan_data', JSON.stringify({
          data: scanData,
          totalCount: totalCount,
          totalQuantity: totalQuantity,
          lastUpdate: new Date().toISOString()
        }));
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadSavedData() {
      try {
        const saved = localStorage.getItem('qr_scan_data');
        if (saved) {
          const parsed = JSON.parse(saved);
          scanData = parsed.data || [];
          totalCount = parsed.totalCount || 0;
          totalQuantity = parsed.totalQuantity || 0;
          updateSummary();
          updateDataDisplay();
        }
      } catch (error) {
        console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportData() {
      if (scanData.length === 0) {
        updateStatus('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      try {
        let csv = '\uFEFFæ—¥ä»˜,å“ç•ª,æ•°é‡,ç®¡ç†ç•ªå·,èª­ã¿å–ã‚Šæ™‚åˆ»\n';
        scanData.forEach(item => {
          csv += `${item.date},${item.productCode},${item.quantity},${item.internalCode},${item.timestamp}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qr_scan_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        updateStatus('ğŸ’¾ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', 'success');
        
      } catch (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—', 'error');
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
    function clearData() {
      if (scanData.length === 0) return;
      
      if (confirm(`ğŸ“› ${totalCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) {
        scanData = [];
        totalCount = 0;
        totalQuantity = 0;
        updateSummary();
        updateDataDisplay();
        saveData();
        updateStatus('ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
      }
    }

    // ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒ£ãƒ³
    function testScan() {
      const testData = '"2025/07/22","85244-63R20-5PKCO","18","SNCA00000090"';
      updateStatus('ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šä¸­...', 'info');
      setTimeout(() => {
        onScanSuccess(testData);
      }, 500);
    }

    // ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯
    async function checkCameraPermission() {
      updateStatus('ğŸ” ã‚«ãƒ¡ãƒ©è¨­å®šã‚’ç¢ºèªä¸­...', 'info');
      
      try {
        // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
        const userAgent = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isAndroid = /Android/.test(userAgent);
        const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
        const isChrome = /Chrome/.test(userAgent);
        
        let message = 'ğŸ“± ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥ã‚«ãƒ¡ãƒ©è¨±å¯æ–¹æ³•:\n\n';
        
        if (isIOS && isSafari) {
          message += `ğŸ iPhone Safari ã®å ´åˆ:\n\n`;
          message += `âœ… æ¨å¥¨æ–¹æ³•:\n`;
          message += `1. ã€ŒğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—\n`;
          message += `2. ç”»é¢ä¸Šéƒ¨ã®è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œè¨±å¯ã€ã‚’ã‚¿ãƒƒãƒ—\n\n`;
          message += `ğŸ”§ æ‰‹å‹•è¨­å®š:\n`;
          message += `â€¢ ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ã€ŒAAã€â†’ã€ŒWebã‚µã‚¤ãƒˆã®è¨­å®šã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€â†’ã€Œè¨±å¯ã€\n`;
          message += `â€¢ ã¾ãŸã¯ iPhoneè¨­å®šâ†’Safariâ†’Webã‚µã‚¤ãƒˆã®è¨­å®šâ†’ã‚«ãƒ¡ãƒ©\n\n`;
        } else if (isAndroid && isChrome) {
          message += `ğŸ¤– Android Chrome ã®å ´åˆ:\n\n`;
          message += `âœ… æ¨å¥¨æ–¹æ³•:\n`;
          message += `1. ã€ŒğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—\n`;
          message += `2. ã€Œã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿã€ã§ã€Œè¨±å¯ã€ã‚’ã‚¿ãƒƒãƒ—\n\n`;
          message += `ğŸ”§ æ‰‹å‹•è¨­å®š:\n`;
          message += `â€¢ ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’â†’ã€Œæ¨©é™ã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€â†’ã€Œè¨±å¯ã€\n`;
          message += `â€¢ ã¾ãŸã¯Chromeè¨­å®šâ†’ã‚µã‚¤ãƒˆã®è¨­å®šâ†’ã‚«ãƒ¡ãƒ©\n\n`;
        } else {
          message += `ğŸŒ ãã®ä»–ãƒ–ãƒ©ã‚¦ã‚¶:\n`;
          message += `1. ã€ŒğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—\n`;
          message += `2. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œè¨±å¯ã€ã‚’é¸æŠ\n`;
          message += `3. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å‘¨è¾ºã®è¨­å®šã‹ã‚‰æ‰‹å‹•ã§è¨±å¯\n\n`;
        }
        
        // MediaDevices API ãƒã‚§ãƒƒã‚¯
        if (!navigator.mediaDevices) {
          message += `âŒ ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“\n`;
          message += `ğŸ’¡ Chrome, Safari, Firefox ãªã©ã®æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠä½¿ã„ãã ã•ã„\n\n`;
        } else {
          message += `âœ… ãƒ–ãƒ©ã‚¦ã‚¶: ã‚«ãƒ¡ãƒ©APIå¯¾å¿œæ¸ˆã¿\n`;
        }
        
        // æ¨©é™çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        try {
          const permission = await navigator.permissions.query({ name: 'camera' });
          message += `ğŸ” ç¾åœ¨ã®æ¨©é™çŠ¶æ…‹: ${permission.state}\n`;
          
          if (permission.state === 'granted') {
            message += `âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯æ¸ˆã¿\n`;
          } else if (permission.state === 'denied') {
            message += `âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™\n`;
            message += `ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‹ã‚‰æ‰‹å‹•ã§è¨±å¯ã—ã¦ãã ã•ã„\n`;
          } else {
            message += `â³ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æœªè¨­å®šï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ç¢ºèªã•ã‚Œã¾ã™ï¼‰\n`;
          }
        } catch (e) {
          message += `â„¹ï¸ æ¨©é™çŠ¶æ…‹ã®ç¢ºèªãŒã§ãã¾ã›ã‚“ã§ã—ãŸ\n`;
        }
        
        // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯
        message += `\nğŸ”’ æ¥ç¶šæ–¹å¼: ${location.protocol}\n`;
        if (location.protocol === 'https:' || location.protocol === 'file:') {
          message += `âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: OK\n`;
        } else {
          message += `âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: HTTPSã¾ãŸã¯file://ãŒå¿…è¦\n`;
        }
        
        alert(message);
        updateStatus('ğŸ” ã‚«ãƒ¡ãƒ©è¨­å®šç¢ºèªå®Œäº†', 'info');
        
      } catch (error) {
        console.error('æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ è¨­å®šç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ', 'error');
      }
    }
    window.addEventListener('beforeunload', function() {
      if (scanner && isScanning) {
        scanner.stop().catch(console.error);
      }
    });
  </script>
</body>
</html>